プロジェクトフォルダ
/home/wsl/dev/mlops/fullstack-dwh-ml-mlops

consfigは
/home/wsl/dev/mlops/fullstack-dwh-ml-mlops/configs

ＣＩＣＤ方針
開発スピード重視のためCIでのlintチェック禁止

raw data を Duckdbに取り込む
DuckDBに取り込んだ rawdataを前処理、ワンホット、外れ値、

添付されたファイルを確認して、dbtで行っているデータ処理について説明いたします。

Ran tool
Read file: src/ml/data/dwh/house_price_dbt/dbt_project.yml
Ran tool
Ran tool
Read file: src/ml/data/dwh/house_price_dbt/models/bronze/bronze_raw_house_data.sql
## dbtで行っているデータ処理の説明

このプロジェクトでは、**Medallion Architecture（メダリオンアーキテクチャ）**に基づいて、3層のデータ処理パイプラインを構築しています。

### 1. アーキテクチャ概要

```
Bronze Layer (生データ) → Silver Layer (クリーンデータ) → Gold Layer (ML用特徴量)
```

### 2. 各層の役割と処理内容

#### **Bronze Layer（ブロンズ層）**
- **目的**: 生データの保存と参照
- **ファイル**: `models/bronze/bronze_raw_house_data.sql`
- **処理内容**: 
  - Pythonのデータ取り込みプロセスで作成された生データを参照
  - データの変換や加工は行わず、そのまま保持
  - テーブル形式でマテリアライズ

#### **Silver Layer（シルバー層）**
- **目的**: データクリーニングと標準化
- **ファイル**: `models/silver/silver_house_data.sql`
- **処理内容**:
  ```sql
  -- データ検証とクリーニング
  - 価格、面積、部屋数などの数値データの妥当性チェック
  - 建設年（1900年〜現在）の範囲チェック
  - 位置情報とコンディションの標準化（大文字変換、トリム）
  
  -- 派生フィールドの計算
  - price_per_sqft（平米単価）
  - house_age（築年数）
  - bed_bath_ratio（寝室・浴室比率）
  
  -- データ品質フラグ
  - is_complete_record（完全レコードフラグ）
  - is_price_outlier（価格外れ値フラグ）
  - is_age_outlier（築年数外れ値フラグ）
  ```

#### **Gold Layer（ゴールド層）**
- **目的**: MLモデル用の特徴量エンジニアリング
- **ファイル**: `models/gold/ft_house_ml.py`
- **処理内容**:

##### **特徴量エンジニアリング**:
```python
# 対数変換（歪んだデータの正規化）
- log_price, log_sqft

# 多項式特徴量
- sqft_squared, price_per_sqft_squared

# 交互作用特徴量
- price_bedrooms_interaction
- price_bathrooms_interaction
- sqft_bedrooms_interaction

# カテゴリカル特徴量
- is_old_house, is_new_house
- is_large_house, is_expensive

# 位置ベース特徴量
- location_avg_price（地域平均価格）
- price_vs_location_avg（地域平均との比較）

# コンディションスコア
- condition_score（数値化）
```

##### **特徴量エンコーディング**:
```python
# ラベルエンコーディング
- location_encoded（位置情報の数値化）

# 前処理アーティファクトの保存
- LabelEncoder, StandardScaler
- 特徴量名、データ統計情報
```

##### **特徴量スケーリング**:
```python
# StandardScalerによる標準化
- 数値特徴量の標準化（平均0、分散1）
- スケール済み特徴量の追加
```

##### **特徴量選択**:
```python
# 相関分析による重要特徴量の選択
- ターゲット変数との相関が高い特徴量を選択
- 必須特徴量の確保
- 最終的に10-15個の特徴量に絞り込み
```

### 3. データ品質管理

#### **dbtテスト**:
- `not_null`: 必須フィールドのNULLチェック
- `unique`: 主キーの重複チェック
- 各層で適切なテストを定義

#### **データ品質フラグ**:
- 完全レコードの識別
- 外れ値の検出とフラグ付け
- データクリーニングの追跡

### 4. 技術的特徴

#### **DuckDB統合**:
- 軽量な分析用データベース
- Pythonとの親和性が高い
- 高速なクエリ実行

#### **Pythonモデル**:
- 複雑な特徴量エンジニアリングをPythonで実装
- scikit-learnライブラリの活用
- 前処理アーティファクトの保存

#### **スキーマ分離**:
- bronze, silver, goldスキーマで層を分離
- データの流れを明確化
- アクセス制御の実装が容易

このアーキテクチャにより、生データからMLモデル用の高品質な特徴量まで、段階的かつ追跡可能なデータ処理パイプラインを実現しています。


行っている機械学習アルゴリズム
