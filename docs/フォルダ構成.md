## 🎯 ゴール

* **重複・多重ネストを一掃**してパス迷子を防ぐ
* Data / ML / Service の三職能を “層” だけで分離
* 1 ファイル 1 役割を守り、`import` が最短になるよう整理

---

## 1. 提案ディレクトリツリー（35 行）

```
fullstack-dwh-mlops/
├── LICENSE
├── README.md
├── Makefile                     # dbt・DuckDB→ML→CI までワンコマンド
├── pyproject.toml               # 依存 & isort/black 共通設定
│
├── configs/                     # 🚚 すべて *.yaml に統一
│   ├── app.yaml
│   ├── envs/{dev,stg,prd}.yaml
│   ├── ml/{model,ensemble,training}.yaml
│   └── requirements/{base,dev,prod}.txt
│
├── infra/                       # “実行環境” を丸ごと
│   ├── docker/docker-compose.yaml
│   ├── mlflow/docker-compose.yaml
│   └── metabase/{Dockerfile,setup.sh,plugins/*}
│
├── docs/                        # 設計 & ADR 置き場
│   ├── architecture.md
│   ├── data-pipeline.md
│   ├── gold-table.md
│   └── how_to_import.md
│
├── src/                         # === Python import root ===
│   ├── core/{__init__,config,logging,exceptions}.py
│   │
│   ├── data/                    # ★ Data Engineering
│   │   ├── raw/house_data.csv
│   │   ├── ingestion/__init__.py
│   │   ├── warehouse/
│   │   │   ├── duckdb/house.duckdb
│   │   │   └── dbt_project/…    # models/{bronze,silver,gold}
│   │   └── validation/__init__.py
│   │
│   ├── ml/                      # ★ ML Engineering
│   │   ├── features/__init__.py
│   │   ├── models/{train_model,train_ensemble}.py
│   │   └── pipeline/train_pipeline.py
│   │
│   ├── services/                # ★ Serving / UI
│   │   ├── api_fastapi/{main.py,schemas.py,helpers.py}
│   │   └── ui_streamlit/app.py
│   │
│   └── tests/                   # unit / integration / e2e
│
└── scripts/                     # リポ外からも再利用できるワンオフ
    ├── create_dwh.py
    └── verify_dwh.py
```

### 変更ハイライト

| Before                   | After                                      | 理由                                           |
| ------------------------ | ------------------------------------------ | -------------------------------------------- |
| `deployment/`            | **`infra/`**                               | “環境” 全般を集約（Docker・K8s・IaC）                   |
| `src/data/dwh/dwh/*`     | **`src/data/warehouse/dbt_project`**       | 循環ネストを除去・`warehouse` 直下へ                     |
| `src/ml/data/dwh/…` のコピー | 🔥 **削除**                                  | Data レイヤは **一元化**、ML からは duckdb 接続で参照        |
| `requirements*.txt` 散在   | `configs/requirements/{base,dev,prod}.txt` | 依存ツリーをワンプレイスに                                |
| 二重 `ml/` & `models/`     | `src/ml` へ統合                               | “モデル定義 vs 学習コード” を `/ml/models` 内で分ける方が読みやすい |
| ドキュメント日本語ファイル名           | `docs/*.md` 英数字                            | OS 依存バグ＆CI 警告を防止                             |

---

## 2. リネーム／移動マッピング（抜粋）

| 移動前                                           | 移動後                                      |
| --------------------------------------------- | ---------------------------------------- |
| `deployment/docker/docker-compose.yaml`       | `infra/docker/docker-compose.yaml`       |
| `deployment/metabase` 全体                      | `infra/metabase`                         |
| `src/data/dwh/dwh/house_price_dbt`            | `src/data/warehouse/dbt_project`         |
| `src/ml/data/raw`                             | `src/data/raw`                           |
| `src/ml/data/dwh/data/house_price_dwh.duckdb` | `src/data/warehouse/duckdb/house.duckdb` |
| `src/ml/models/train_model.py`                | `src/ml/models/train_model.py` ※パスは同じ    |
| `docs/汎用データ前処理テンプレート設計書.md`                   | `docs/data-pipeline.md`                  |

> **Tip:**
> `git mv OLD NEW` で履歴を保ったまま移動すると PR Diff が最小になります。

---

## 3. インポートパス影響

```python
# 旧
from src.ml.data.dwh.core.database import DuckDBClient
# 新
from src.data.warehouse.core.database import DuckDBClient
```

`sed` 一発置換例:

```bash
find src -type f -name "*.py" \
  -exec sed -i 's/src\.ml\.data\.dwh/src.data.warehouse/g' {} +
```

---

## 4. CI/CD 変更点

1. **PYTHONPATH** に `src/` だけ通せば OK（多重ネスト解消）
2. `DB_PATH` を `src/data/warehouse/duckdb/house.duckdb` へ更新
3. lint 無効化方針は据え置き、`pytest -q` と `dbt test` だけ実行推奨

---

## 5. 移行フロー（安全手順）

1. **ブランチを切る**  → `git checkout -b refactor/dir-layout`
2. 上記 **`git mv`** で物理移動
3. `sed` or `pytest --collect-only` で import エラーを洗い替え
4. CI 通過を確認して `main` へマージ

---

### まとめ

* “**Data / ML / Service**” という 3 階層でフォルダを水平分割
* 二重 `dwh/dwh` や ML 側のデータコピーを **排除**し、単一ソース化
* これで **パス名は最短５セグメント以下**、VSCode の検索結果も激減します。

了解です。**推論 API／UI は Kaggle コンペには不要**なので `src/services` を丸ごと削除したシンプル構成に更新します。

---

## 最小構成ツリー（32 行）

```
fullstack-dwh-mlops/
├── LICENSE
├── README.md
├── Makefile
├── pyproject.toml
│
├── configs/
│   ├── app.yaml
│   ├── envs/{dev,stg,prd}.yaml
│   ├── ml/{model,ensemble,training}.yaml
│   └── requirements/{base,dev,prod}.txt
│
├── infra/                      # Kaggle では使わなくても削除不要
│   ├── docker/docker-compose.yaml
│   ├── mlflow/docker-compose.yaml
│   └── metabase/…
│
├── docs/
│   ├── architecture.md
│   ├── data-pipeline.md
│   ├── gold-table.md
│   └── how_to_import.md
│
├── src/
│   ├── core/{__init__,config,logging,exceptions}.py
│   │
│   ├── data/
│   │   ├── raw/house_data.csv
│   │   ├── ingestion/__init__.py
│   │   ├── warehouse/
│   │   │   ├── duckdb/house.duckdb
│   │   │   └── dbt_project/…        # bronze / silver / gold
│   │   └── validation/__init__.py
│   │
│   ├── ml/
│   │   ├── features/__init__.py
│   │   ├── models/{train_model,train_ensemble}.py
│   │   └── pipeline/train_pipeline.py
│   │
│   └── tests/                       # unit / integration / e2e
│
└── scripts/
    ├── create_dwh.py
    └── verify_dwh.py
```

### 変更点

| 削除対象                                                           | 影響                                                                                           |
| -------------------------------------------------------------- | -------------------------------------------------------------------------------------------- |
| `src/services/api_fastapi/*` <br>`src/services/ui_streamlit/*` | Kaggle カーネルは notebook 実行のみ。推論は notebook 内で直接呼び出すか、`ml` モジュールの predict 関数を import して利用してください。 |

そのほかのフォルダは **学習・検証に必須**なので残しています。CI やローカル検証で Serving が必要になった場合は、`services` ディレクトリを別ブランチで保持しておくと安全です。
