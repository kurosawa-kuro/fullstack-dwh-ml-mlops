## â€œæ±ç”¨ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆâ€è¨­è¨ˆæ›¸

> **ã©ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚‚æµç”¨ã§ãã‚‹æ§˜ã«** â€• æ‰‹é †ãƒ»å‘½åè¦ç´„ãƒ»ä¿å­˜ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ **æŠ½è±¡åŒ–** ã—ã¾ã—ãŸã€‚
> ï¼ˆæ•°å­—ã¯ãƒ¦ãƒ¼ã‚¶æç¤ºã®ç« ç«‹ã¦ã¨å¯¾å¿œï¼‰

---

### 1. æ´¾ç”Ÿãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¨ˆç®—  *(Derived Features)*

| ç¨®åˆ¥         | ä»£è¡¨ãƒ‘ã‚¿ãƒ¼ãƒ³                          | æ¨å¥¨å‘½å                                    | NULL è¦å‰‡         | å‚™è€ƒ           |
| ---------- | ------------------------------- | --------------------------------------- | --------------- | ------------ |
| **æ¯”ç‡**     | `price / sqft`                  | `<numer>/<denom> â†’ {numer}_per_{denom}` | é™¤ç®—ä¸å¯ âœ `NULL`   | æ­£è¦åŒ– & å˜ä½å·®å¸å  |
| **å·®åˆ†**     | `event_time â€“ first_event_time` | `delta_<from>_<to>`                     | æ¬ æç‰‡å´ã‚ã‚Š âœ `NULL` | æ»åœ¨ãƒ»çµŒéæ™‚é–“      |
| **ãƒã‚±ãƒƒãƒˆ**   | `age > 50`                      | `is_old_*`                              | BOOL (0/1)      | å››åˆ†ä½, ãƒ‰ãƒ¡ã‚¤ãƒ³é–¾å€¤ã§ |
| **é †ä½/ãƒ©ãƒ³ã‚¯** | `rank() over (â€¦)`               | `<col>_rank_pct`                        | 0â€“1 DOUBLE      | åˆ†å¸ƒä½ç½®ã‚’ä¿æŒ      |
| **æ—¥æ™‚åˆ†è§£**   | `order_dt` â†’ Y/M/D              | `year_*, month_*, day_*`                | 0 ä»£å…¥ä¸å¯          | å­£ç¯€æ€§ãƒ»å‘¨æœŸæ€§      |

---

### 2. å¤–ã‚Œå€¤æ¤œå‡ºã¨å‡¦ç†  *(Outlier Handling)*

| ã‚¹ãƒ†ãƒƒãƒ—           | ãƒ¡ã‚½ãƒƒãƒ‰              | æ¨å¥¨ãƒ­ã‚¸ãƒƒã‚¯                                        | ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°                       |
| -------------- | ----------------- | --------------------------------------------- | ---------------------------- |
| **2.1 çµ±è¨ˆçš„**    | IQRÃ—1.5 / z-score | `lower = Q1 â€“ kÂ·IQR`<br>`upper = Q3 + kÂ·IQR`  | *é™¤å¤–* or *Winsorize*ï¼ˆé–¾å€¤ã§åˆ‡ã‚Šè©°ã‚ï¼‰ |
| **2.2 ãƒ‰ãƒ¡ã‚¤ãƒ³**   | ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«           | ä¾‹) `age >100`, `price_per_sqft <50`           | ãƒ•ãƒ©ã‚°åˆ— `is_<col>_outlier` ä»˜ä¸   |
| **2.3 å®Œå…¨ãƒ¬ã‚³ãƒ¼ãƒ‰** | **å“è³ªãƒã‚¹ã‚¯**         | `is_complete_record = every(col IS NOT NULL)` | Gold ä»¥é™ã§ **WHERE** å¥ã«ä½¿ç”¨      |

---

### 3. ãƒ¯ãƒ³ãƒ›ãƒƒãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°  *(Categorical Encoding)*

| ãƒã‚¤ãƒ³ãƒˆ        | æ¨å¥¨å€¤                                                   |
| ----------- | ----------------------------------------------------- |
| **ã‚«ãƒ©ãƒ é¸å®š**   | `unique_count â‰¤ 50` ã‚’ç›®å®‰ï¼ˆé«˜éãã‚‹å ´åˆã¯ **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°** æ¤œè¨ï¼‰ |
| **æœªçŸ¥ã‚«ãƒ†ã‚´ãƒª**  | `handle_unknown='ignore'` ã‚‚ã—ãã¯ãƒ€ãƒŸãƒ¼åˆ— `unknown_FLAG`     |
| **å¤šé‡å…±ç·šæ€§**   | `drop='first'`ï¼ˆæœ€åˆã®ãƒ€ãƒŸãƒ¼å‰Šé™¤ï¼‰                              |
| **æ‰‹å‹•ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰** | `pd.get_dummies(drop_first=True)` ã‚’çµ±ä¸€ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°åŒ–          |

---

### 4. ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°  *(Gold Layer)*

| #   | ã‚«ãƒ†ã‚´ãƒª         | å…¸å‹åˆ—ä¾‹               | å®Ÿè£…æŒ‡é‡                                               |
| --- | ------------ | ------------------ | -------------------------------------------------- |
| 4.1 | **å¯¾æ•°å¤‰æ›**     | å³è£¾é‡ã„é‡‘é¡ãƒ»é¢ç©          | `log1p()` ã§ 0 å€¤å¯                                   |
| 4.2 | **å¤šé …å¼**      | é¢ç©Â², å˜ä¾¡Â³           | `PolynomialFeatures(degreeâ‰¤3, include_bias=False)` |
| 4.3 | **äº¤äº’ä½œç”¨**     | `price Ã— bedrooms` | é‡è¦çµ„åˆã›ã®ã¿äº‹å‰è¨­è¨ˆ                                        |
| 4.4 | **ã‚«ãƒ†ã‚´ãƒªãƒã‚±ãƒƒãƒˆ** | `is_large_house` ç­‰ | å››åˆ†ä½ãƒ»æ¥­ç•Œé–¾å€¤                                           |
| 4.5 | **ä½ç½®æ´¾ç”Ÿ**     | åœ°åŸŸå¹³å‡ä¾¡æ ¼, ãƒ©ãƒ³ã‚¯        | Window é›†è¨ˆ (`avg`, `rank`)                          |
| 4.6 | **é †åºã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰**  | å“è³ªã‚¹ã‚³ã‚¢              | Dict ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆYAML ç®¡ç†ï¼‰                                |

---

### 5. ç‰¹å¾´é‡ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°  *(Scaling)*

| ãƒ•ã‚§ãƒ¼ã‚º         | æ‰‹æ³•                                  | é©ç”¨åˆ—      | ä¿å­˜ç‰©                  |
| ------------ | ----------------------------------- | -------- | -------------------- |
| **æ¬ æè£œå®Œ**     | `SimpleImputer(mean/most_frequent)` | å…¨æ•°å€¤ï¼ã‚«ãƒ†ã‚´ãƒª | â€“                    |
| **æ¨™æº–åŒ–**      | `StandardScaler`                    | æ•°å€¤åˆ—      | `feature_scaler.pkl` |
| **æ­£å‰‡åŒ– (ä»»æ„)** | `MinMaxScaler`                      | ãƒ¢ãƒ‡ãƒ«ä¾å­˜ã§   | `minmax_scaler.pkl`  |

---

### 6. å‰å‡¦ç†ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜  *(Reproducibility)*

| ãƒ•ã‚¡ã‚¤ãƒ«                | å†…å®¹                                        | ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ |
| ------------------- | ----------------------------------------- | ------ |
| `feature_names.pkl` | ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°åˆ—é †ãƒªã‚¹ãƒˆ                               | Pickle |
| `data_stats.pkl`    | mean / std / min / max / median           | Pickle |
| `*_mapping.pkl`     | ã‚«ãƒ†ã‚´ãƒªâ†’æ•´æ•°/é »åº¦è¾æ›¸                              | Pickle |
| `*_scaler.pkl`      | å­¦ç¿’æ¸ˆ Scikit-Learn ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ                   | Pickle |
| **ãƒ¡ã‚¿**              | `schema_hash.txt`, `pipeline_version.txt` | Text   |

> **ãƒ«ãƒ¼ãƒ«** : *ã€Œå­¦ç¿’æ™‚ã«ç”Ÿæˆã—ãŸã‚‚ã®ã¯å¿…ãšä¿å­˜ â†’ æ¨è«–æ™‚ã«å†åˆ©ç”¨ã€*
> ãƒ‘ã‚¹ã¯ `target/preprocessing_artifacts/{YYYYMMDD_HHMMSS}/`.

---

### 7. æœ€å°ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæŠœç²‹ï¼‰

```python
# ====== outlier mask (IQR) ======
def iqr_mask(s, k=1.5):
    q1, q3 = s.quantile([0.25, 0.75])
    iqr = q3 - q1
    return (s < q1 - k*iqr) | (s > q3 + k*iqr)

# ====== encoder / scaler pipeline ======
preprocessor = ColumnTransformer(
    transformers=[
        ("num", Pipeline([
            ("imputer", SimpleImputer(strategy="mean")),
            ("scaler", StandardScaler())
        ]), num_cols),
        ("cat", Pipeline([
            ("imputer", SimpleImputer(strategy="most_frequent")),
            ("ohe", OneHotEncoder(handle_unknown="ignore", drop="first", sparse_output=False))
        ]), cat_cols)
    ],
    remainder="drop"
)
```

---

## ä½¿ã„æ–¹ãƒ•ãƒ­ãƒ¼

1. **Silver** ã§ QC ï¼†æ´¾ç”ŸåŸºç¤åˆ— â†’ `is_*_outlier`, `is_complete_record`
2. **Gold** ã§ **4.x** ã®é«˜æ¬¡ç‰¹å¾´é‡ã‚’è¿½åŠ 
3. `preprocessor.fit(df_gold)` â†’ Pickle ä¿å­˜
4. ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ï¼MLflow ãƒ­ã‚°

---

### ğŸ“Œ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¾ã¨ã‚

* **â€œé–¢æ•°å˜ä½â€** ã§å‡¦ç†ã‚’åˆ‡ã‚Šã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’æ›¸ã
* ãƒã‚¤ãƒ‘ãƒ© (IQR å€æ•°ãƒ»å¤šé …å¼æ¬¡æ•°ãªã©) ã¯ **YAML** ã§å¤–å‡ºã—
* å¤‰æ›å¾Œåˆ—ã¯ `<orig>_<suffix>` å‘½åã§ç”±æ¥ã‚’æ˜ç¢ºã«
* ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¯ **æ—¥æ™‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³** ã§è¡çªé˜²æ­¢
* ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã® **hash** ã‚’ãƒ¢ãƒ‡ãƒ«ã«ã‚¿ã‚°ä»˜ã‘ã—ã€ãƒ‡ãƒ¼ã‚¿ drift ã‚’æ¤œçŸ¥

ã“ã‚Œã§ã€Œã‚ˆãã‚ã‚‹å‰å‡¦ç†ãƒ‘ãƒ¼ãƒ„ã€ãŒ**ä¸€æšã®ä»•æ§˜**ã§è¦‹æ¸¡ã›ã€
èª°ã§ã‚‚åŒã˜ãƒ«ãƒ¼ãƒ«ã§å†å®Ÿè£…ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™ã€‚
